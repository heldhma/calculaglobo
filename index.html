<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Servi√ßos e Impostos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --cor-fundo: #f4f7f9;
            --cor-container: #ffffff;
            --cor-borda: #dee2e6;
            --cor-borda-foco: #007bff;
            --cor-principal: #007bff;
            --cor-secundaria: #6c757d;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-aviso: #ffc107;
            --cor-texto: #212529;
            --sombra-caixa: 0 4px 20px rgba(0, 0, 0, 0.08);
            --raio-borda: 8px;
            --transicao-rapida: all 0.2s ease-in-out;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); font-size: 14px; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 380px; background-color: var(--cor-container); border-right: 1px solid var(--cor-borda); padding: 24px; display: flex; flex-direction: column; transition: var(--transicao-rapida); }
        .sidebar h2 { font-size: 24px; font-weight: 700; margin: 0 0 20px 0; }
        #searchInput { width: 100%; padding: 10px 15px; border: 1px solid var(--cor-borda); border-radius: var(--raio-borda); margin-bottom: 20px; font-size: 14px; transition: var(--transicao-rapida); }
        #searchInput:focus { outline: none; border-color: var(--cor-borda-foco); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
        .lista-prestadores { flex-grow: 1; overflow-y: auto; margin-right: -10px; padding-right: 10px;}
        .prestador-item { display: flex; align-items: center; padding: 12px; border-radius: var(--raio-borda); cursor: pointer; margin-bottom: 8px; transition: var(--transicao-rapida); }
        .prestador-item.selected { background-color: #e6f4ff; border-left: 4px solid var(--cor-principal); padding-left: 8px;}
        .prestador-item:hover { background-color: #f8f9fa; transform: translateX(5px); }
        .prestador-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 1em; color: white; font-weight: bold; flex-shrink: 0; }
        .prestador-info h4 { margin: 0; font-weight: 600; font-size: 15px; }
        .tag { font-size: 0.75em; padding: 2px 8px; border-radius: 12px; background-color: #e9ecef; color: #495057; margin-left: 8px; font-weight: 500;}
        .sidebar-botoes { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn { background-color: var(--cor-principal); color: white; border: none; padding: 12px; border-radius: var(--raio-borda); cursor: pointer; font-size: 14px; font-weight: 600; transition: var(--transicao-rapida); width: 100%; text-align: center; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secundario { background-color: var(--cor-secundaria); }
        .main-content { flex-grow: 1; padding: 24px 32px; display: flex; flex-direction: column; overflow-y: auto; }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 15px; }
        .header-title { flex-grow: 1; }
        .header-title #nome-selecionado { font-size: 32px; font-weight: 700; }
        .header-title #data-atual { font-weight: 500; font-size: 14px; color: #6c757d; }
        .header-actions .btn { width: auto; }
        .detalhes-prestador { background: var(--cor-container); padding: 30px; border-radius: var(--raio-borda); box-shadow: var(--sombra-caixa); flex-grow: 1;}
        .detalhes-prestador p { color: var(--cor-texto-claro); }
        .detalhes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 28px; }
        .detalhe-item span { display: block; font-size: 13px; color: var(--cor-texto-claro); margin-bottom: 4px; text-transform: uppercase; }
        .detalhe-item strong { font-size: 15px; word-break: break-word; }
        .acoes { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; }
        .btn-acao { padding: 10px 20px; border-radius: var(--raio-borda); font-weight: 600; border: none; cursor: pointer; color: white; transition: var(--transicao-rapida);}
        .btn-acao:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-whatsapp { background-color: var(--cor-sucesso); }
        .btn-editar { background-color: var(--cor-aviso); color: #333; }
        .btn-deletar { background-color: var(--cor-perigo); }
        .modal { display: flex; justify-content: center; align-items: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal.ativo { opacity: 1; visibility: visible; }
        .modal-content { background-color: #fff; padding: 32px; border: none; width: 90%; max-width: 900px; border-radius: var(--raio-borda); position: relative; box-shadow: var(--sombra-caixa); transform: scale(0.95); transition: var(--transicao-rapida); max-height: 90vh; overflow-y: auto; }
        .modal.ativo .modal-content { transform: scale(1); }
        .modal-content h2, .modal-content h3 { font-size: 22px; font-weight: 600; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        .close { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 32px; font-weight: bold; cursor: pointer; transition: var(--transicao-rapida); }
        .close:hover { color: var(--cor-perigo); transform: rotate(90deg); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        .form-group label { font-size: 14px; font-weight: 500; margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--cor-borda); border-radius: 6px; font-size: 14px; transition: var(--transicao-rapida); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--cor-borda-foco); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: var(--cor-principal); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; position: absolute; right: 12px; top: 38px; display: none; }
        .form-group.loading .spinner { display: block; }
        .btn-salvar { background-color: var(--cor-sucesso); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .action-btn { font-size: 12px; padding: 5px 10px; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .resultado-calculo { margin-top: 20px; padding: 20px; border-radius: var(--raio-borda); line-height: 1.8; background-color: #f8f9fa; border: 1px solid var(--cor-borda);}
        .resultado-calculo h3 { font-size: 18px; margin-bottom: 15px; border: none; padding-bottom: 0;}
        .resultado-calculo p { margin: 10px 0; display: flex; justify-content: space-between; padding-bottom: 10px; font-size: 15px; }
        .resultado-calculo p:not(:last-child) { border-bottom: 1px dashed #eee; }
        .resultado-calculo span { font-weight: bold; }
        .resultado-calculo .desconto { color: var(--cor-perigo); }
        .resultado-calculo .total { color: var(--cor-sucesso); font-size: 1.2em;}
        /* NOVO DESIGN DO CRUD DE CIDADES */
        .cidade-crud-container { display: grid; grid-template-columns: 320px 1fr; gap: 30px; }
        .cidade-lista { border-left: 1px solid var(--cor-borda); padding-left: 30px; height: 400px; overflow-y: auto; }
        .cidade-card { background: #f8f9fa; padding: 15px; border-radius: var(--raio-borda); margin-bottom: 10px; border: 1px solid #eee; }
        .cidade-card h4 { margin-bottom: 10px; font-size: 16px; }
        .cidade-card p { font-size: 13px; margin-bottom: 10px; color: #555; }
        .cidade-card-actions { text-align: right; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h2>Prestadores</h2>
            <input type="text" id="searchInput" placeholder="Buscar por nome, cidade, NF...">
            <div id="lista-prestadores"></div>
            <div class="sidebar-botoes">
                <button class="btn" id="abrir-modal-prestador-btn">+ Adicionar Prestador</button>
                <button class="btn btn-secundario" id="abrir-modal-calculadora-btn">Calculadora RPA</button>
                <button class="btn btn-secundario" id="abrir-modal-cidades-btn">Gerenciar Cidades</button>
                <hr>
                <button class="btn btn-secundario" id="export-json-btn">Exportar Dados (Backup)</button>
                <button class="btn btn-secundario" id="import-json-btn">Importar Dados (Backup)</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-title">
                    <h2 id="nome-selecionado">Selecione um prestador</h2>
                    <div id="data-atual"></div>
                </div>
                <div class="header-actions">
                    <button class="btn" id="gerar-relatorio-btn" style="background-color: #17a2b8;">Gerar Relat√≥rio</button>
                </div>
            </header>
            <div id="detalhes-prestador" class="detalhes-prestador">
                <p>Selecione um prestador na lista √† esquerda para ver seus detalhes.</p>
            </div>
        </main>
    </div>

    <div id="prestador-modal" class="modal"><div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="prestador-modal-titulo">Adicionar Prestador</h2>
        <form id="prestador-form">
            <input type="hidden" id="id" name="id">
            <h3>Dados Pessoais</h3>
            <div class="form-grid">
                <div class="form-group"><label for="nome">Nome Completo</label><input type="text" id="nome" name="nome" required></div>
                <div class="form-group"><label for="cpf">CPF</label><input type="text" id="cpf" name="cpf" required></div>
                <div class="form-group"><label for="rg">RG</label><input type="text" id="rg" name="rg"></div>
                <div class="form-group"><label for="celular">Celular</label><input type="text" id="celular" name="celular" required></div>
                <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" name="email"></div>
                <div class="form-group"><label for="pis_pasep">PIS/PASEP</label><input type="text" id="pis_pasep" name="pis_pasep"></div>
            </div>
            <hr><h3>Endere√ßo</h3>
            <div class="form-grid">
                <div class="form-group" id="cep-group"><label for="cep">CEP</label><input type="text" id="cep" name="cep" maxlength="8" required><div class="spinner"></div></div>
                <div class="form-group"><label for="cidadeId">Cidade</label><select id="cidadeId" name="cidadeId" required><option value="">Selecione...</option></select></div>
                <div class="form-group"><label for="logradouro">Endere√ßo</label><input type="text" id="logradouro" name="logradouro"></div>
                <div class="form-group"><label for="numero">N√∫mero</label><input type="text" id="numero" name="numero"></div>
                <div class="form-group"><label for="bairro">Bairro</label><input type="text" id="bairro" name="bairro"></div>
                <div class="form-group"><label for="estado">Estado</label><input type="text" id="estado" name="estado"></div>
            </div>
            <hr><h3>Dados de Pagamento</h3>
            <div class="form-grid">
                 <div class="form-group"><label for="emite_nf_rpa">Emiss√£o</label><select id="emite_nf_rpa" name="emite_nf_rpa"><option value="">NF ou RPA?</option><option value="NF">NF</option><option value="RPA">RPA</option></select></div>
                 <div class="form-group"><label for="tipo_pagamento">Pagamento</label><select id="tipo_pagamento" name="tipo_pagamento"><option value="">Forma?</option><option value="Dep√≥sito em Conta">Dep√≥sito</option><option value="Ordem de Pagamento">Ordem de Pagamento</option></select></div>
                <div class="form-group"><label for="nome_banco">Banco</label><input type="text" id="nome_banco" name="nome_banco"></div>
                <div class="form-group"><label for="codigo_banco">C√≥d. Banco</label><input type="text" id="codigo_banco" name="codigo_banco"></div>
                <div class="form-group"><label for="agencia_bancaria">Ag√™ncia</label><input type="text" id="agencia_bancaria" name="agencia_bancaria"></div>
                <div class="form-group"><label for="conta_bancaria">Conta</label><input type="text" id="conta_bancaria" name="conta_bancaria"></div>
                <div class="form-group"><label for="tipo_conta">Tipo Conta</label><select id="tipo_conta" name="tipo_conta"><option value="">Tipo?</option><option value="Corrente">Corrente</option><option value="Poupan√ßa">Poupan√ßa</option></select></div>
            </div>
            <button type="submit" class="btn btn-salvar" style="margin-top:20px;">Salvar Prestador</button>
        </form>
    </div></div>

    <div id="cidade-modal" class="modal"><div class="modal-content">
        <span class="close">&times;</span>
        <h2>Gerenciar Cidades e Impostos</h2>
        <div class="cidade-crud-container">
            <div class="cidade-form-wrapper">
                <h3 id="cidade-form-titulo">Adicionar Cidade</h3>
                <form id="cidade-form">
                    <input type="hidden" id="cidade-id">
                    <div class="form-group"><label for="cidade-nome">Nome da Cidade</label><input type="text" id="cidade-nome" required></div>
                    <div class="form-group"><label for="cidade-iss">ISS (%)</label><input type="number" step="0.01" id="cidade-iss" required></div>
                    <button type="submit" class="btn btn-salvar">Salvar Cidade</button>
                    <button type="button" class="btn btn-secundario" id="cancelar-edicao-cidade-btn" style="display:none; margin-top: 10px;">Cancelar Edi√ß√£o</button>
                </form>
            </div>
            <div class="cidade-lista">
                 <h3>Cidades Cadastradas</h3>
                 <div id="cidades-lista-container"></div>
            </div>
        </div>
    </div></div>

    <div id="calculadora-modal" class="modal"><div class="modal-content">
         <span class="close">&times;</span>
        <h2>Simulador de Impostos (RPA)</h2>
        <div class="form-group"><label for="calc-valor-bruto">Valor Bruto do Servi√ßo (R$)</label><input type="number" id="calc-valor-bruto" placeholder="Ex: 3500.00"></div>
        <div class="form-group"><label for="calc-cidade">Cidade da Presta√ß√£o do Servi√ßo</label><select id="calc-cidade"><option value="">Selecione a cidade</option></select></div>
        <button id="calcular-btn" class="btn">Calcular</button>
        <div id="resultado-calculo" class="resultado-calculo" style="margin-top:20px;"><p>Preencha os valores para simular.</p></div>
    </div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DB_KEY = 'gestorAppDB_final_v8';
        let db = {
            cidades: [
                { id: 1, nome: 'Recife', iss_aliquota: 5 },
                { id: 2, nome: 'Jaboat√£o dos Guararapes', iss_aliquota: 5 },
                { id: 3, nome: 'Olinda', iss_aliquota: 5 },
                { id: 4, nome: 'Paulista', iss_aliquota: 5 },
            ],
            prestadores: []
        };
        let prestadorSelecionadoId = null;

        const DOMElements = {
            listaPrestadores: document.getElementById('lista-prestadores'),
            detalhesPrestador: document.getElementById('detalhes-prestador'),
            nomeSelecionado: document.getElementById('nome-selecionado'),
            dataAtual: document.getElementById('data-atual'),
            searchInput: document.getElementById('searchInput'),
            prestadorModal: document.getElementById('prestador-modal'),
            cidadeModal: document.getElementById('cidade-modal'),
            calculadoraModal: document.getElementById('calculadora-modal'),
            prestadorForm: document.getElementById('prestador-form'),
            cidadeForm: document.getElementById('cidade-form'),
            cidadesListaContainer: document.getElementById('cidades-lista-container'),
            calcCidadeSelect: document.getElementById('calc-cidade'),
            resultadoCalculo: document.getElementById('resultado-calculo'),
            prestadorCidadeSelect: document.getElementById('cidadeId'),
            jsonFileInput: document.createElement('input'),
        };
        DOMElements.jsonFileInput.type = 'file';
        DOMElements.jsonFileInput.accept = '.json';
        DOMElements.jsonFileInput.style.display = 'none';
        document.body.appendChild(DOMElements.jsonFileInput);
        
        const salvarDB = () => localStorage.setItem(DB_KEY, JSON.stringify(db));
        const carregarDB = () => {
            const dadosSalvos = localStorage.getItem(DB_KEY);
            if (dadosSalvos) {
                const dadosParseados = JSON.parse(dadosSalvos);
                db.cidades = dadosParseados.cidades || [];
                db.prestadores = dadosParseados.prestadores || [];
            } else {
                salvarDB();
            }
        };

        const abrirModal = (modal) => modal.classList.add('ativo');
        const fecharModal = (modal) => modal.classList.remove('ativo');

        // --- CIDADES ---
        let cidadeEmEdicaoId = null;
        function renderizarCidades() {
            DOMElements.cidadesListaContainer.innerHTML = '';
            const selects = document.querySelectorAll('#calc-cidade, #cidadeId');
            selects.forEach(s => { s.innerHTML = '<option value="">Selecione...</option>'; });
            db.cidades.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c => {
                const cidadeCard = document.createElement('div');
                cidadeCard.className = 'cidade-card';
                cidadeCard.innerHTML = `<h4>${c.nome}</h4><p><strong>ISS:</strong> ${c.iss_aliquota}%</p><div class="cidade-card-actions"><button class="action-btn edit-btn" onclick="iniciarEdicaoCidade(${c.id})">Editar</button><button class="action-btn delete-btn" onclick="deletarCidade(${c.id})">X</button></div>`;
                DOMElements.cidadesListaContainer.appendChild(cidadeCard);
                selects.forEach(s => s.add(new Option(c.nome, c.id)));
            });
        }
        function resetarFormCidade() {
            cidadeEmEdicaoId = null;
            DOMElements.cidadeForm.reset();
            document.getElementById('cidade-form-titulo').textContent = "Adicionar Nova Cidade";
            DOMElements.cidadeForm.querySelector('button').textContent = "Salvar Cidade";
            document.getElementById('cancelar-edicao-cidade-btn').style.display = 'none';
        }
        window.iniciarEdicaoCidade = (id) => {
            const c = db.cidades.find(c => c.id === id);
            if (!c) return;
            cidadeEmEdicaoId = id;
            document.getElementById('cidade-form-titulo').textContent = "Editar Cidade";
            DOMElements.cidadeForm.querySelector('#cidade-id').value = c.id;
            DOMElements.cidadeForm.querySelector('#cidade-nome').value = c.nome;
            DOMElements.cidadeForm.querySelector('#cidade-iss').value = c.iss_aliquota;
            DOMElements.cidadeForm.querySelector('button').textContent = "Atualizar";
            document.getElementById('cancelar-edicao-cidade-btn').style.display = 'block';
        };
        window.deletarCidade = (id) => {
            if (confirm('Tem certeza?')) {
                db.cidades = db.cidades.filter(c => c.id !== id);
                db.prestadores.forEach(p => { if (p.cidadeId == id) p.cidadeId = ''; });
                salvarDB(); renderizarCidades(); renderizarPrestadores();
            }
        };
        DOMElements.cidadeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const cidadeData = {
                nome: DOMElements.cidadeForm.querySelector('#cidade-nome').value,
                iss_aliquota: parseFloat(DOMElements.cidadeForm.querySelector('#cidade-iss').value),
                inss_aliquota: 11
            };
            if (cidadeEmEdicaoId) {
                const index = db.cidades.findIndex(c => c.id === cidadeEmEdicaoId);
                db.cidades[index] = { ...cidadeData, id: cidadeEmEdicaoId };
            } else {
                cidadeData.id = Date.now();
                db.cidades.push(cidadeData);
            }
            salvarDB(); renderizarCidades(); resetarFormCidade();
        });
        document.getElementById('cancelar-edicao-cidade-btn').addEventListener('click', resetarFormCidade);
        
        // --- PRESTADORES ---
        let prestadorEmEdicaoId = null;
        function renderizarPrestadores(lista = db.prestadores) {
            DOMElements.listaPrestadores.innerHTML = '';
            if (lista.length === 0) { DOMElements.listaPrestadores.innerHTML = '<p style="text-align:center; padding: 10px; color: #888;">Nenhum prestador cadastrado.</p>'; return; }
            lista.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(p => {
                const item = document.createElement('div');
                item.className = 'prestador-item';
                item.onclick = () => selecionarPrestador(p.id);
                if (p.id === prestadorSelecionadoId) item.classList.add('selected');
                const iniciais = p.nome.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                item.innerHTML = `<div class="prestador-avatar" style="background-color: ${gerarCorAleatoria(p.nome)}">${iniciais}</div><div class="prestador-info"><h4>${p.nome}</h4></div>${p.emite_nf_rpa ? `<span class="tag">${p.emite_nf_rpa}</span>` : ''}`;
                DOMElements.listaPrestadores.appendChild(item);
            });
        }
        window.selecionarPrestador = (id) => {
            prestadorSelecionadoId = id;
            const p = db.prestadores.find(pr => pr.id === id);
            if (!p) {
                DOMElements.detalhesPrestador.innerHTML = '<p>Selecione um prestador da lista.</p>';
                DOMElements.nomeSelecionado.textContent = 'Selecione um prestador';
                renderizarPrestadores();
                return;
            };
            DOMElements.nomeSelecionado.textContent = p.nome;
            const cidade = db.cidades.find(c => c.id == p.cidadeId) || {nome: 'N/A'};
            DOMElements.detalhesPrestador.innerHTML = `<div class="detalhes-grid">
                <div class="detalhe-item"><span>CPF/RG</span><strong>${p.cpf || 'N/A'} / ${p.rg || 'N/A'}</strong></div>
                <div class="detalhe-item"><span>Contato</span><strong>${p.celular || 'N/A'} / ${p.email || 'N/A'}</strong></div>
                <div class="detalhe-item"><span>Endere√ßo</span><strong>${p.logradouro || ''}, ${p.numero || 'S/N'} - ${p.bairro || ''}, ${cidade.nome} - ${p.estado || ''}</strong></div>
                <div class="detalhe-item"><span>CEP</span><strong>${p.cep || 'N/A'}</strong></div>
                <div class="detalhe-item"><span>Emiss√£o / Pagamento</span><strong>${p.emite_nf_rpa || 'N/A'} / ${p.tipo_pagamento || 'N/A'}</strong></div>
                <div class="detalhe-item"><span>Banco</span><strong>${p.nome_banco || 'N/A'} (${p.codigo_banco || 'N/A'})</strong></div>
                <div class="detalhe-item"><span>Conta</span><strong>Ag. ${p.agencia_bancaria || 'N/A'} / Conta ${p.conta_bancaria || 'N/A'} (${p.tipo_conta || 'N/A'})</strong></div>
            </div>
            <div class="acoes">
                <button class="btn btn-acao btn-whatsapp" onclick="enviarWhatsapp('${p.celular}', '${p.nome}')">WhatsApp</button>
                <button class="btn btn-acao btn-editar" onclick="abrirModalPrestador(${p.id})">Editar</button>
                <button class="btn btn-acao btn-deletar" onclick="deletarPrestador(${p.id})">Deletar</button>
            </div>`;
            renderizarPrestadores();
        }
        window.deletarPrestador = (id) => {
            if (confirm('Tem certeza?')) {
                db.prestadores = db.prestadores.filter(p => p.id !== id);
                salvarDB();
                prestadorSelecionadoId = null;
                selecionarPrestador(null);
            }
        }
        window.abrirModalPrestador = (id = null) => {
            prestadorEmEdicaoId = id;
            DOMElements.prestadorForm.reset();
            document.getElementById('prestador-modal-titulo').textContent = id ? 'Editar Prestador' : 'Adicionar Prestador';
            if (id) {
                const p = db.prestadores.find(pr => pr.id === id);
                DOMElements.prestadorForm.querySelectorAll('[name]').forEach(el => { if(p[el.name]) el.value = p[el.name]; });
            }
            abrirModal(DOMElements.prestadorModal);
        }
        DOMElements.prestadorForm.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(DOMElements.prestadorForm);
            const prestadorData = Object.fromEntries(formData.entries());
            if (prestadorEmEdicaoId) {
                prestadorData.id = prestadorEmEdicaoId;
                const index = db.prestadores.findIndex(p => p.id === prestadorEmEdicaoId);
                db.prestadores[index] = prestadorData;
            } else {
                prestadorData.id = Date.now();
                db.prestadores.push(prestadorData);
            }
            salvarDB(); renderizarPrestadores(); fecharModal(DOMElements.prestadorModal);
            selecionarPrestador(prestadorEmEdicaoId || prestadorData.id);
            prestadorEmEdicaoId = null;
        });

        // --- CALCULADORA ---
        document.getElementById('calcular-btn').addEventListener('click', () => {
            const valorBruto = parseFloat(document.getElementById('calc-valor-bruto').value);
            const cidadeId = Number(document.getElementById('calc-cidade').value);
            if (!valorBruto || !cidadeId) return alert('Preencha todos os campos.');
            const cidade = db.cidades.find(c => c.id === cidadeId);
            if (!cidade) return alert('Cidade n√£o encontrada.');
            
            const INSS_ALIQUOTA = 0.11;
            const IRRF_LIMITE_ISENCAO = 1903.98;
            const tetoINSS = 7786.02;

            const baseINSS = Math.min(valorBruto, tetoINSS);
            const valorINSS = baseINSS * INSS_ALIQUOTA;
            const baseIRRF = valorBruto - valorINSS;
            let valorIRRF = 0;

            if (baseIRRF > IRRF_LIMITE_ISENCAO) {
                if (baseIRRF <= 2826.65) valorIRRF = (baseIRRF * 0.075) - 142.80;
                else if (baseIRRF <= 3751.05) valorIRRF = (baseIRRF * 0.15) - 354.80;
                else if (baseIRRF <= 4664.68) valorIRRF = (baseIRRF * 0.225) - 636.13;
                else valorIRRF = (baseIRRF * 0.275) - 869.36;
            }
            valorIRRF = Math.max(0, valorIRRF);
            const valorISS = valorBruto * (cidade.iss_aliquota / 100);
            const valorLiquido = valorBruto - valorINSS - valorIRRF - valorISS;

            DOMElements.resultadoCalculo.innerHTML = `<h3>Resumo do C√°lculo</h3><p>Valor Bruto: <span>R$ ${valorBruto.toFixed(2)}</span></p><p>INSS (11%): <span class="desconto">- R$ ${valorINSS.toFixed(2)}</span></p><p>ISS (${cidade.iss_aliquota}%): <span class="desconto">- R$ ${valorISS.toFixed(2)}</span></p><p>IRRF (Tabela Progressiva): <span class="desconto">- R$ ${valorIRRF.toFixed(2)}</span></p><hr><p><strong>Valor L√≠quido:</strong> <span class="total">R$ ${valorLiquido.toFixed(2)}</span></p>`;
        });
        
        // --- CEP E OUTROS ---
        document.getElementById('cep').addEventListener('input', async (e) => {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                document.getElementById('cep-group').classList.add('loading');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) { alert('CEP n√£o encontrado.'); } 
                    else {
                        DOMElements.prestadorForm.querySelector('#logradouro').value = data.logradouro;
                        DOMElements.prestadorForm.querySelector('#bairro').value = data.bairro;
                        DOMElements.prestadorForm.querySelector('#estado').value = data.uf;
                        const cidadeEncontrada = db.cidades.find(c => c.nome.toLowerCase() === data.localidade.toLowerCase());
                        if (cidadeEncontrada) DOMElements.prestadorForm.querySelector('#cidadeId').value = cidadeEncontrada.id;
                        DOMElements.prestadorForm.querySelector('#numero').focus();
                    }
                } catch { alert('N√£o foi poss√≠vel buscar o CEP.'); }
                 finally { document.getElementById('cep-group').classList.remove('loading'); }
            }
        });
        
        const exportarParaJSON = () => {
            if (db.prestadores.length === 0 && db.cidades.length === 0) return alert('N√£o h√° dados para exportar.');
            const dataStr = JSON.stringify(db, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `backup_gestor_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        };
        const importarDeJSON = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (confirm('Isso ir√° substituir todos os dados atuais. Deseja continuar?')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const dataFromFile = JSON.parse(ev.target.result);
                        if (dataFromFile.cidades && dataFromFile.prestadores) {
                            db = dataFromFile;
                            salvarDB(); init();
                            alert('Dados importados com sucesso!');
                        } else { alert('Arquivo de backup inv√°lido.'); }
                    } catch { alert('Erro ao ler o arquivo.'); }
                };
                reader.readAsText(file);
            }
            e.target.value = '';
        };
        const gerarRelatorio = () => {
            if (db.prestadores.length === 0) return alert('Nenhum prestador para gerar relat√≥rio.');
            let html = `<html><head><title>Relat√≥rio de Prestadores</title><style>@media print { .page-break { page-break-after: always; } } body{font-family:sans-serif;margin:20px;} h1,h2{text-align:center;margin-bottom:20px;color:#333} .prestador-card{border:1px solid #ccc;padding:20px;margin-bottom:20px;border-radius:8px;} .prestador-card h3{margin-top:0;border-bottom:2px solid #eee;padding-bottom:10px;margin-bottom:15px;} .grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;} .item p{margin:0;padding:5px 0;border-bottom:1px solid #f0f0f0;} .item strong{color:#555;margin-right:8px;}</style></head><body>`;
            html += `<h1>Relat√≥rio de Prestadores</h1><p style="text-align:center;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>`;
            db.prestadores.forEach(p => {
                const cidade = db.cidades.find(c => c.id == p.cidadeId) || {nome: 'N/A'};
                html += `<div class="prestador-card page-break"><h3>${p.nome}</h3><div class="grid">
                         <div class="item">
                            <p><strong>CPF:</strong>${p.cpf || ''}</p>
                            <p><strong>RG:</strong>${p.rg || ''}</p>
                            <p><strong>Celular:</strong>${p.celular || ''}</p>
                            <p><strong>Email:</strong>${p.email || ''}</p>
                         </div>
                         <div class="item">
                            <p><strong>Endere√ßo:</strong>${p.logradouro || ''}, ${p.numero || 'S/N'}</p>
                            <p><strong>Bairro:</strong>${p.bairro || ''}</p>
                            <p><strong>Cidade:</strong>${cidade.nome} - ${p.estado || ''}</p>
                            <p><strong>CEP:</strong>${p.cep || ''}</p>
                         </div>
                         <div class="item">
                            <p><strong>Banco:</strong>${p.nome_banco || ''} (${p.codigo_banco || ''})</p>
                            <p><strong>Ag√™ncia:</strong>${p.agencia_bancaria || ''}</p>
                            <p><strong>Conta:</strong>${p.conta_bancaria || ''} (${p.tipo_conta || ''})</p>
                         </div>
                         <div class="item">
                            <p><strong>Emiss√£o:</strong>${p.emite_nf_rpa || ''}</p>
                            <p><strong>Pagamento:</strong>${p.tipo_pagamento || ''}</p>
                            <p><strong>PIS/PASEP:</strong>${p.pis_pasep || ''}</p>
                         </div>
                         </div></div>`;
            });
            html += '</body></html>';
            const newWindow = window.open();
            newWindow.document.write(html);
            newWindow.document.close();
        };
        
        function init() {
            carregarDB(); renderizarCidades(); renderizarPrestadores();
            DOMElements.dataAtual.textContent = new Date().toLocaleDateString('pt-BR', { timeZone: 'America/Recife' });
        }
        window.enviarWhatsapp = (nome, numero) => {
            if (!numero) return alert("Sem celular cadastrado.");
            const mensagem = `Ol√°, ${numero}! Entro em contato referente aos seus servi√ßos.`;
            const link = `https://wa.me/55${nome.replace(/\D/g, '')}?text=${encodeURIComponent(mensagem)}`;
            window.open(link, '_blank');
        };
        
        document.getElementById('abrir-modal-prestador-btn').addEventListener('click', () => abrirModalPrestador());
        document.getElementById('abrir-modal-cidades-btn').addEventListener('click', () => abrirModal(DOMElements.cidadeModal));
        document.getElementById('abrir-modal-calculadora-btn').addEventListener('click', () => abrirModal(DOMElements.calculadoraModal));
        
        document.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', (e) => fecharModal(e.target.closest('.modal'))));
        document.getElementById('export-json-btn').addEventListener('click', exportarParaJSON);
        document.getElementById('import-json-btn').addEventListener('click', () => DOMElements.jsonFileInput.click());
        document.getElementById('gerar-relatorio-btn').addEventListener('click', gerarRelatorio);
        DOMElements.jsonFileInput.addEventListener('change', importarDeJSON);
        DOMElements.searchInput.addEventListener('input', () => {
             const termo = DOMElements.searchInput.value.toLowerCase().trim();
             const listaFiltrada = !termo ? db.prestadores : db.prestadores.filter(p => Object.values(p).some(val => String(val).toLowerCase().includes(termo)));
            renderizarPrestadores(listaFiltrada);
        });
        function gerarCorAleatoria(str) { if (!str || str.length === 0) return '#cccccc'; let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); let cor = '#'; for (let i = 0; i < 3; i++) cor += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).substr(-2); return cor; }

        init();
    });
    </script>
</body>
</html>